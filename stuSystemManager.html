<!DOCTYPE html>
<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Ext Demo</title>

<head>
    <link rel="stylesheet" type="text/css" href="./ext-3.3.0/resources/css/ext-all.css" />
    <script type="text/javascript" src="./ext-3.3.0/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="./ext-3.3.0/ext-all.js"></script>
    <script>
        Ext.onReady(function () {
            var menu = new Ext.menu.Menu({
                items: [{
                    id: 'deleteNode',
                    text: 'Delete Node',
                }, {
                    id: 'addNode',
                    text: 'Add Node'
                }],
                listeners: {
                    itemclick: function (item) {
                        tree.expandAll();
                        let currentNode = item.parentMenu.contextNode;
                        console.log(currentNode);
                        switch (item.id) {
                            case 'deleteNode':
                                if (currentNode.parentNode) {
                                    currentNode.remove();
                                }
                                break;
                            case 'addNode':
                                if (currentNode.isLeaf()) {
                                    let newNode = new Ext.tree.TreeNode({
                                        text: currentNode.text,
                                        leaf: true,
                                    });
                                    currentNode.parentNode.insertBefore(newNode, currentNode);
                                } else {
                                    if (currentNode.childNodes.every(n => n.leaf === true)) {
                                        let newNode = new Ext.tree.TreeNode({
                                            text: currentNode.text,
                                            leaf: true,
                                        });
                                        currentNode.appendChild(newNode);
                                    } else {
                                        let newNode = new Ext.tree.TreeNode({
                                            text: currentNode.text
                                        });
                                        currentNode.appendChild(newNode);
                                    }
                                }
                        }
                    }
                }
            });
            var root = new Ext.tree.AsyncTreeNode({ text: 'All BL/Shipments', expanded: true });
            var selectNode = '';
            var inputStuOrClsInfo = '';
            var tree = new Ext.tree.TreePanel({
                width: 500,
                height: 400,
                animate: true,
                enableDD: true,
                collapsible: true,
                root: root,
                selModel: new Ext.tree.MultiSelectionModel({}),
                loader: new Ext.tree.TreeLoader({ dataUrl: 'stuSystem.txt' }),
                contextMenu: menu,
                listeners: {
                    contextmenu: function (node, e) {
                        node.select();
                        var treeContextMenu = node.getOwnerTree().contextMenu;
                        treeContextMenu.contextNode = node;
                        treeContextMenu.showAt(e.getXY());
                    },
                    click: function (node, e) {
                        selectNode = '';
                        selectNode = node;
                    }
                },
            });
            var viewport = new Ext.Viewport({
                layout: 'border',
                items: [{
                    xtype: 'form',
                    region: 'west',
                    width: 500,
                    border: true,
                    layout: 'accordion',
                    items: [tree]
                }, {
                    region: 'center',
                    split: true,
                    border: true,
                    xtype: 'form',
                    labelWidth: 160,
                    items: [{
                        xtype: 'textfield',
                        fieldLabel: '请输入学生或班级信息',
                        listeners: {
                            change: function (field, newValue, oldValue) {
                                inputStuOrClsInfo = newValue;
                            },
                        }
                    }],
                    buttons: [{
                        text: 'add',
                        listeners: {
                            'click': function (btn, form) {
                                tree.expandAll();
                                if (!selectNode) {
                                    let newNode = new Ext.tree.TreeNode({
                                        text: 'text'
                                    });
                                    tree.getRootNode().appendChild(newNode);
                                } else {
                                    if (selectNode.isLeaf()) {
                                        let newNode = new Ext.tree.TreeNode({
                                            text: inputStuOrClsInfo,
                                            leaf: true,
                                        });
                                        selectNode.parentNode.insertBefore(newNode, selectNode);
                                    } else {
                                        if (selectNode.childNodes.every(n => n.leaf === true)) {
                                            let newNode = new Ext.tree.TreeNode({
                                                text: inputStuOrClsInfo,
                                                leaf: true,
                                            });
                                            selectNode.appendChild(newNode);
                                        } else {
                                            let newNode = new Ext.tree.TreeNode({
                                                text: selectNode.text
                                            });
                                            selectNode.appendChild(newNode);
                                        }
                                    }
                                }
                            }
                        }
                    }]
                }]
            });
            var treeEditor = new Ext.tree.TreeEditor(tree, { allowBlank: false }, {
                listeners: {
                    complete: function (editor, currVal, origVal) {

                    }
                }
            });
        });
    </script>
</head>

<body>
</body>

</html>